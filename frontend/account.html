<!DOCTYPE html>
<html>
<head>
  <title>My Account</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .review { border: 1px solid #ccc; margin: 10px 0; padding: 10px; }
    .stars span { color: gray; }
    .stars .filled { color: gold; }
  </style>
</head>
<body>
  <h1>My Account</h1>
  <div id="userinfo"></div>
  <h2>My Reviews</h2>
  <div id="reviews"></div>

  <script>
    function renderStars(rating) {
      let stars = '';
      for (let i = 1; i <= 5; i++) {
        stars += `<span class="${i <= rating ? 'filled' : ''}">â˜…</span>`;
      }
      return stars;
    }

    function loadReviews() {
      fetch('/account/reviews')
        .then(res => res.json())
        .then(data => {
          if (data.error) {
            document.body.innerHTML = '<p>Please log in to view this page.</p>';
            return;
          }
          document.getElementById('userinfo').innerHTML =
            `<p><b>Username:</b> ${data.user.username}</p>`;

          const reviewsDiv = document.getElementById('reviews');
          reviewsDiv.innerHTML = '';
          data.reviews.forEach(r => {
            reviewsDiv.innerHTML += `
              <div class="review" data-id="${r.id}">
                <p><b>Quality:</b> <span class="stars">${renderStars(r.quality)}</span></p>
                <p><b>Value:</b> <span class="stars">${renderStars(r.value)}</span></p>
                <p><b>Usability:</b> <span class="stars">${renderStars(r.usability)}</span></p>
                <p><b>Design:</b> <span class="stars">${renderStars(r.design)}</span></p>
                <p><b>Support:</b> <span class="stars">${renderStars(r.support)}</span></p>
                <p><b>Review:</b> ${r.textReview}</p>
                <button onclick="editReview(${r.id}, ${r.quality}, ${r.value}, ${r.usability}, ${r.design}, ${r.support}, \`${r.textReview}\`)">Edit</button>
                <button onclick="deleteReview(${r.id})">Delete</button>
              </div>`;
          });
        });
    }

    function editReview(id, q, v, u, d, s, text) {
      const reviewDiv = document.querySelector(`[data-id='${id}']`);
      reviewDiv.innerHTML = `
        <form onsubmit="saveReview(event, ${id})">
          <label>Quality: <input type="number" name="quality" min="1" max="5" value="${q}"></label><br>
          <label>Value: <input type="number" name="value" min="1" max="5" value="${v}"></label><br>
          <label>Usability: <input type="number" name="usability" min="1" max="5" value="${u}"></label><br>
          <label>Design: <input type="number" name="design" min="1" max="5" value="${d}"></label><br>
          <label>Support: <input type="number" name="support" min="1" max="5" value="${s}"></label><br>
          <textarea name="textReview">${text}</textarea><br>
          <button type="submit">Save</button>
        </form>`;
    }

    function saveReview(e, id) {
      e.preventDefault();
      const form = e.target;
      const data = {
        quality: parseInt(form.quality.value),
        value: parseInt(form.value.value),
        usability: parseInt(form.usability.value),
        design: parseInt(form.design.value),
        support: parseInt(form.support.value),
        textReview: form.textReview.value
      };
      fetch(`/account/reviews/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(res => {
        if (res.success) {
          loadReviews();
        } else {
          alert(res.error || 'Error saving review');
        }
      });
    }

    function deleteReview(id) {
      if (!confirm("Are you sure you want to delete this review?")) return;
      fetch(`/account/reviews/${id}`, {
        method: 'DELETE'
      })
      .then(res => res.json())
      .then(res => {
        if (res.success) {
          loadReviews();
        } else {
          alert(res.error || 'Error deleting review');
        }
      });
    }

    loadReviews();
  </script>
</body>
</html>
